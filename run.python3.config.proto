# nsjail config for safe execution of user Python scripts
name: "python-script-executor"

mode: ONCE
time_limit: 30         # Max CPU time for the script
cwd: "/app"

# Disable all Linux namespaces since we are unprivileged
clone_newuser: false
clone_newnet: false
clone_newns: false
clone_newpid: false
clone_newipc: false
clone_newuts: false
clone_newcgroup: false
clone_newtime: false

# Resource limits
rlimit_as: 268435456     # 256MB memory
rlimit_cpu: 10           # 10 seconds CPU time
rlimit_fsize: 10485760   # 10MB max file size
rlimit_nofile: 64        # Max open files
rlimit_nproc: 32         # Max processes

# Environment
envar: "PATH=/opt/venv/bin:/usr/bin:/bin"
envar: "PYTHONDONTWRITEBYTECODE=1"
envar: "PYTHONUNBUFFERED=1"
envar: "HOME=/tmp"

# Skip operations that fail in Cloud Run / unprivileged containers
skip_setsid: true
keep_caps: false
disable_no_new_privs: true

# Mount only whatâ€™s necessary
mount { src: "/app" dst: "/app" is_bind: true rw: true }          # user scripts
mount { src: "/opt/venv" dst: "/opt/venv" is_bind: true rw: false } # preinstalled libraries (numpy, pandas, etc.)
mount { dst: "/tmp" fstype: "tmpfs" rw: true options: "size=50M,nr_inodes=1024" }  # temp files for scripts
mount { dst: "/dev/null" fstype: "bind" rw: true }               # minimal device files
mount { dst: "/dev/urandom" fstype: "bind" rw: true }            # random numbers for Python

# Execute Python script
exec_bin {
  path: "/opt/venv/bin/python3"
}